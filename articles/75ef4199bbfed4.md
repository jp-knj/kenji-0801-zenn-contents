---
title: "Import On Interaction"
emoji: "📚"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---
ユーザーがリソースを必要とするUIを操作したときに、重要でないリソースを遅延ロードする。

ページには、すぐに必要でないコンポーネントやリソースのコードやデータが含まれていることがあります。例えば、ページの一部をクリックしたりスクロールしたりしない限り、ユーザーが目にすることのないユーザーインターフェースの一部などです。これは、あなたがオーサリングした多くの種類のファーストパーティコードに適用できますが、ビデオプレーヤーやチャットウィジェットなどのサードパーティウィジェットにも適用され、通常、ボタンをクリックしてメインインターフェイスを表示する必要があります。

これらのリソースを熱心に (つまりすぐに) ロードすると、コストがかかる場合はメインスレッドをブロックし、ユーザーがページの重要な部分とやり取りできるまでの時間を短縮することができます。これは、First Input Delay、Total Blocking Time、Time to Interactiveなどのインタラクション・レディネス・メトリクスに影響を与える可能性があります。これらのリソースをすぐにロードするのではなく、次のような、より適切なタイミングでロードすることができます。

ユーザーがそのコンポーネントを初めて操作するためにクリックしたとき
コンポーネントをスクロールして表示する
または、ブラウザがアイドルになるまでそのコンポーネントのロードを延期する（requestIdleCallbackを使用）。
リソースをロードするさまざまな方法は、高レベルで、次のとおりです。

Eager - リソースをすぐにロードする（スクリプトの通常のロード方法）。
Lazy (ルートベース) - ユーザーがルートまたはコンポーネントに移動したときにロードされます。
Lazy (On interaction) - ユーザーが UI をクリックしたときにロードされます (例: チャットの表示)。
Lazy (In viewport) - ユーザーがコンポーネントに向かってスクロールしたときにロードされます。
プリフェッチ - 必要になる前にロードし、重要なリソースがロードされた後にロードする。
プリロード - 切望して、より緊急性の高いもの
注：ファーストパーティーコードのインポートオンインタラクションは、インタラクションの前にリソースをプリフェッチできない場合にのみ実行すべきです。しかし、このパターンはサードパーティのコードに非常に適しており、一般に、重要でない場合は後の時点に延期することになります。これはさまざまな方法で実現できます（インタラクションが発生するまで、ブラウザがアイドル状態になるまで、またはその他のヒューリスティックを使用して延期します）。
インタラクション時に機能コードを遅延してインポートすることは、この投稿で取り上げる多くの文脈で使用されるパターンです。Google Docsでは、ユーザーとのインタラクションがあるまでロードを延期することで、共有機能のための500KBのスクリプトのロードを節約しています。

インポート・オン・インタラクションがうまく機能するもう一つの場所は、サードパーティーのウィジェットを読み込むことです。

## サードパーティーのUIをファサードで読み込む "フェイク"
サードパーティのスクリプトをインポートする場合、レンダリング内容やコードの読み込みタイミングをあまり制御できないことがあります。ロードオンインタラクションを実装するための1つの選択肢は、ファサードを使用するという単純明快なものです。ファサードは、より高価なコンポーネントのためのシンプルな「プレビュー」または「プレースホルダー」であり、画像やスクリーンショットなど、基本的な体験をシミュレートすることができます。Lighthouseのチームでは、このアイデアを専門用語として使っています。

ユーザーが「プレビュー」（ファサード）をクリックすると、そのリソースのコードが読み込まれます。これにより、ユーザーは、その機能を使用する予定がない場合、その機能に必要なエクスペリエンス・コストを支払う必要がなくなるのです。同様に、ファサードは、ホバー時に必要なリソースに事前に接続することができます。

注：サードパーティーのリソースは、サイト全体の読み込みを十分に考慮せずにページに追加されることがよくあります。同期的にロードされるサードパーティーのスクリプトは、ブラウザのパーサーをブロックし、読み込みを遅らせる可能性があります。可能であれば、3Pスクリプトは非同期/遅延（または他のアプローチ）でロードし、1Pスクリプトがネットワーク帯域を奪われないようにする必要があります。重要なものでなければ、import-on-interactionなどのパターンを使って遅延ロードに移行させるのがよいでしょう。
動画プレーヤーの埋め込み
ファサード」の良い例として、Paul Irish氏によるYouTube Lite Embedがあります。これは、YouTube Video ID を受け取り、最小限のサムネイルと再生ボタンを表示するカスタム要素を提供します。この要素をクリックすると、YouTube の埋め込みコードが動的に読み込まれます。つまり、再生をクリックしないユーザーは、埋め込みコードの取得と処理にかかるコストを支払う必要がありません。