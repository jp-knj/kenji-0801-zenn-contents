---
title: ""
emoji: "📚"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

## ダイナミックインポート
オンデマンドでコードの一部を取り込む

今回のチャットアプリケーションでは、4つの重要なコンポーネントがあります。UserInfo、ChatList、ChatInput、EmojiPickerです。しかし、これらのコンポーネントのうち、最初のページロード時に即座に使用されるのは、3つだけです。UserInfo、ChatList、ChatInputです。EmojiPicker は直接表示されず、ユーザーが EmojiPicker を切り替えるために Emoji をクリックしない場合は、まったくレンダリングされない可能性もあります。この場合、EmojiPicker モジュールを不必要に初期バンドルに追加することになり、ロード時間が長くなる可能性があります!

これを解決するために、EmojiPickerコンポーネントを動的にインポートすることができます。静的にインポートするのではなく、EmojiPickerを表示するときだけインポートするのです。Reactでコンポーネントを動的にインポートする簡単な方法は、React Suspenseを使用することです。React.Suspensionコンポーネントは、動的にロードされるべきコンポーネントを受け取り、EmojiPickerモジュールのインポートを一時停止することで、Appコンポーネントのコンテンツをより速くレンダリングすることを可能にします！React.Suspensionコンポーネントは、EmojiPickerモジュールのインポートを一時停止します。ユーザーが絵文字をクリックすると、EmojiPicker コンポーネントが初めてレンダリングされます。EmojiPicker コンポーネントは Suspense コンポーネントをレンダリングし、このコンポーネントが遅延インポートされたモジュール (この場合は EmojiPicker) を受け取ります。Suspense コンポーネントは、fallback prop を受け取り、suspended コンポーネントのロード中にレンダリングされるべきコンポーネントを受け取ります。

EmojiPicker を不必要に初期バンドルに追加する代わりに、独自のバンドルに分割し、初期バンドルのサイズを小さくすることができます!

初期バンドルサイズが小さくなれば、初期ロードが速くなります。ユーザーは、長い間、空白のロード画面を見つめる必要がなくなります。フォールバックコンポーネントは、アプリケーションがフリーズしていないことをユーザーに知らせます：ユーザーは、モジュールが処理され実行されるまで少し待つ必要があるだけです。

```
Asset                             Size         Chunks            Chunk Names
emoji-picker.bundle.js           1.48 KiB      1    [emitted]    emoji-picker
main.bundle.js                   1.33 MiB      main [emitted]    main
vendors~emoji-picker.bundle.js   171 KiB       2    [emitted]    vendors~emoji-picker
```

従来は初期バンドルが1.5MiBだったのに対し、EmojiPickerのインポートを停止することで、1.33MiBに減らすことができました

コンソールでは、EmojiPickerをトグルするまで実行されないことが分かります
```javascript
import React, { Suspense, lazy } from "react";
// import Send from "./icons/Send";
// import Emoji from "./icons/Emoji";
const Send = lazy(() =>
import(/*webpackChunkName: "send-icon" */ "./icons/Send")
);
const Emoji = lazy(() =>
import(/*webpackChunkName: "emoji-icon" */ "./icons/Emoji")
);
// Lazy load EmojiPicker  when <EmojiPicker /> renders
const Picker = lazy(() =>
import(/*webpackChunkName: "emoji-picker" */ "./EmojiPicker")
);

const ChatInput = () => {
const [pickerOpen, togglePicker] = React.useReducer(state => !state, false);

    return (
      <Suspense fallback={<p id="loading">Loading...</p>}>
        <div className="chat-input-container">
          <input type="text" placeholder="Type a message..." />
          <Emoji onClick={togglePicker} />
          {pickerOpen && <Picker />}
          <Send />
        </div>
      </Suspense>
    );
};

console.log("ChatInput loaded", Date.now());

export default ChatInput;
```

アプリケーションをビルドすると、Webpackが作成したさまざまなバンドルが表示されます。

EmojiPicker コンポーネントを動的にインポートすることで、最初のバンドルサイズを 1.5MiB から 1.33MiB に減らすことに成功しました! EmojiPicker が完全にロードされるまで、ユーザーはまだしばらく待たなければなりませんが、ユーザーがコンポーネントのロードを待っている間、アプリケーションがレンダリングされ、インタラクティブになるようにすることで、ユーザーエクスペリエンスを向上させることができました。

## ローダブルコンポーネント
サーバーサイドレンダリングは（まだ）React Suspenseをサポートしていません。React Suspenseに代わるものとして、loadable-componentsライブラリがあり、SSRアプリケーションで使用できます。

```javascript
import React from "react";
import loadable from "@loadable/component";

import Send from "./icons/Send";
import Emoji from "./icons/Emoji";

const EmojiPicker = loadable(() => import("./EmojiPicker"), {
  fallback: <div id="loading">Loading...</div>
});

const ChatInput = () => {
  const [pickerOpen, togglePicker] = React.useReducer(state => !state, false);

  return (
    <div className="chat-input-container">
      <input type="text" placeholder="Type a message..." />
      <Emoji onClick={togglePicker} />
      {pickerOpen && <EmojiPicker />}
      <Send />
    </div>
  );
};

export default ChatInput;
```

React Suspense と同様に、遅延インポートされたモジュールを loadable に渡すことで、EmojiPicker モジュールがリクエストされたときだけ、モジュールをインポートします モジュールがロードされている間、フォールバックコンポーネントをレンダリングすることができます。

loadable コンポーネントは SSR アプリケーションで React Suspense に代わる素晴らしい方法ですが、CSR アプリケーションでもモジュールのインポートを一時停止するために有用です。
```javascript
import React from "react";
  import Send from "./icons/Send";
  import Emoji from "./icons/Emoji";
  import loadable from "@loadable/component";

  const EmojiPicker = loadable(() => import("./components/EmojiPicker"), {
    fallback: <p id="loading">Loading...</p>
  });

  const ChatInput = () => {
    const [pickerOpen, togglePicker] = React.useReducer(state => !state, false);

    return (
      <div className="chat-input-container">
        <input type="text" placeholder="Type a message..." />
        <Emoji onClick={togglePicker} />
        {pickerOpen && <EmojiPicker />}
        <Send />
      </div>
    );
  };

  console.log("ChatInput loaded", Date.now());

  export default ChatInput;
```